<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ–ãƒ­ã‚°ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-panel: #1e2a45;
      --accent: #e94560;
      --accent-dim: #c73a52;
      --text: #eaeaea;
      --text-dim: #8899aa;
      --border: #2a3a55;
      --cell-hover: rgba(233,69,96,0.12);
      --cell-selected: rgba(233,69,96,0.22);
      --success: #2ecc71;
      --success-dim: #27ae60;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      -webkit-user-select: none;
      user-select: none;
      -webkit-app-region: drag;
    }
    .app-header button, .app-header .header-actions {
      -webkit-app-region: no-drag;
    }
    .app-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .app-title .icon { color: var(--accent); font-size: 22px; }
    .header-actions { display: flex; gap: 8px; }

    /* ===== ã‚¿ãƒ–ãƒŠãƒ“ ===== */
    .tab-nav {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 10px 24px;
      border: none;
      background: transparent;
      color: var(--text-dim);
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn:hover { color: var(--text); background: rgba(233,69,96,0.05); }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .tab-content { display: none; flex: 1; overflow: hidden; }
    .tab-content.active { display: flex; flex-direction: column; }

    /* ===== ãƒœã‚¿ãƒ³å…±é€š ===== */
    .btn {
      padding: 7px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-panel);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn:hover { border-color: var(--accent); background: rgba(233,69,96,0.1); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 500; }
    .btn-primary:hover { background: var(--accent-dim); }
    .btn-success { background: var(--success); border-color: var(--success); color: #fff; font-weight: 500; }
    .btn-success:hover { background: var(--success-dim); }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .btn-danger { background: transparent; border-color: #e74c3c; color: #e74c3c; }
    .btn-danger:hover { background: rgba(231,76,60,0.1); }

    /* ============================================================
       è¨­å®šã‚¿ãƒ–
       ============================================================ */
    .settings-page {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }
    .settings-container {
      max-width: 720px;
      margin: 0 auto;
    }
    .settings-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .settings-section-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-hint {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.6;
      margin-top: 8px;
    }
    .path-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .path-row label {
      font-size: 13px;
      color: var(--text-dim);
      white-space: nowrap;
      min-width: 120px;
    }
    .path-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text);
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .path-row input:focus { outline: none; border-color: var(--accent); }
    .path-row .btn { flex-shrink: 0; }

    .path-list {
      margin-top: 12px;
    }
    .path-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .path-item .path-alias {
      color: var(--accent);
      font-weight: 600;
      min-width: 80px;
    }
    .path-item .path-value {
      flex: 1;
      font-family: 'Courier New', monospace;
      color: var(--text);
      word-break: break-all;
    }
    .path-item .btn-sm { flex-shrink: 0; }

    .save-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--success);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .save-indicator.show { opacity: 1; }

    /* ============================================================
       ã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ–
       ============================================================ */
    .editor-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
    .side-panel {
      width: 290px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    .panel-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .panel-section:last-child { border-bottom: none; }
    .panel-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ */
    .form-row { margin-bottom: 10px; }
    .form-row:last-child { margin-bottom: 0; }
    .form-row label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    textarea.cell-text-input {
      width: 100%;
      min-height: 80px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      line-height: 1.6;
    }
    textarea.cell-text-input:focus { outline: none; border-color: var(--accent); }
    select, input[type="number"], input[type="color"], input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
    }
    select:focus, input:focus { outline: none; border-color: var(--accent); }
    input[type="color"] { height: 34px; padding: 2px 4px; cursor: pointer; }

    /* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
    .toggle-group {
      display: flex;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .toggle-btn {
      flex: 1;
      padding: 6px 0;
      border: none;
      background: var(--bg-primary);
      color: var(--text-dim);
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .toggle-btn + .toggle-btn { border-left: 1px solid var(--border); }
    .toggle-btn.active { background: var(--accent); color: #fff; }
    .toggle-btn:hover:not(.active) { background: rgba(233,69,96,0.1); color: var(--text); }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
    .preview-area {
      flex: 1;
      overflow: auto;
      padding: 24px;
      display: flex;
      justify-content: center;
      background: #f5f5f5;
    }
    .preview-wrapper {
      position: relative;
      width: 100%;
      max-width: 1200px;
    }
    .grid-container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ã‚°ãƒªãƒƒãƒ‰è¡Œ */
    .grid-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
      aspect-ratio: 3 / 1;
    }
    .grid-cell {
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: outline 0.15s;
      outline: 2px solid transparent;
      display: flex;
    }
    .grid-cell:hover { outline-color: rgba(233,69,96,0.4); }
    .grid-cell.selected { outline-color: var(--accent); }
    .grid-cell { background: transparent; }

    .cell-content {
      width: 100%;
      height: 100%;
      padding: 12px;
      display: flex;
      overflow: hidden;
      word-break: break-word;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .cell-content.h-write { writing-mode: horizontal-tb; }
    .cell-content.v-write { writing-mode: vertical-rl; }
    .cell-content.align-left   { justify-content: flex-start; text-align: left; }
    .cell-content.align-center { justify-content: center; text-align: center; }
    .cell-content.align-right  { justify-content: flex-end; text-align: right; }
    .cell-content.v-write.align-left   { align-items: flex-end; }
    .cell-content.v-write.align-center { align-items: center; }
    .cell-content.v-write.align-right  { align-items: flex-start; }
    .cell-content.valign-top    { align-items: flex-start; }
    .cell-content.valign-middle { align-items: center; }
    .cell-content.valign-bottom { align-items: flex-end; }
    .cell-content.v-write.valign-top    { justify-content: flex-start; }
    .cell-content.v-write.valign-middle { justify-content: center; }
    .cell-content.v-write.valign-bottom { justify-content: flex-end; }

    /* ã‚»ãƒ«ç•ªå·ãƒãƒƒã‚¸ */
    .cell-badge {
      position: absolute;
      top: 4px; left: 4px;
      font-size: 9px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 1px 5px;
      border-radius: 3px;
      pointer-events: none;
      opacity: 0.6;
    }

    /* MDãƒ¢ãƒ¼ãƒ‰ãƒãƒƒã‚¸ */
    .md-badge {
      position: absolute;
      top: 4px; right: 4px;
      font-size: 8px;
      background: rgba(91,168,255,0.5);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
      pointer-events: none;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
    .grid-cell.drag-over {
      outline-color: var(--success) !important;
      background: rgba(46,204,113,0.15) !important;
    }
    .grid-cell.has-image .cell-content {
      padding: 0;
    }
    .grid-cell.has-image .cell-content img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 8px;
    }
    .image-badge {
      position: absolute;
      bottom: 4px; left: 4px;
      font-size: 9px;
      background: rgba(46,204,113,0.7);
      color: #fff;
      padding: 1px 6px;
      border-radius: 3px;
      pointer-events: none;
      max-width: calc(100% - 8px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .image-remove-btn {
      position: absolute;
      top: 4px; right: 4px;
      width: 20px; height: 20px;
      border-radius: 50%;
      border: none;
      background: rgba(231,76,60,0.8);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    .grid-cell.has-image:hover .image-remove-btn { display: flex; }

    /* ===== å½±ãƒ—ãƒªã‚»ãƒƒãƒˆ ===== */
    .shadow-sm  { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08); }
    .shadow-md  { box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1); }
    .shadow-lg  { box-shadow: 0 10px 30px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.1); }
    .shadow-glow { box-shadow: 0 0 25px rgba(233,69,96,0.5), 0 0 60px rgba(233,69,96,0.3), 0 0 100px rgba(233,69,96,0.15); }
    .shadow-hard { box-shadow: 5px 5px 0px rgba(0,0,0,0.2); }

    /* ===== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes zoomIn { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }
    @keyframes bounce { 0% { opacity:0; transform:translateY(30px); } 60% { opacity:1; transform:translateY(-8px); } 80% { transform:translateY(3px); } 100% { transform:translateY(0); } }
    @keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.03); } }
    @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-8px); } }
    @keyframes clickFadeOut { from { opacity:1; transform:scale(1); } to { opacity:0; transform:scale(0.95); } }

    .anim-fadeIn     { animation: fadeIn 0.6s ease both; }
    .anim-slideUp    { animation: slideUp 0.6s ease both; }
    .anim-slideLeft  { animation: slideLeft 0.6s ease both; }
    .anim-slideRight { animation: slideRight 0.6s ease both; }
    .anim-zoomIn     { animation: zoomIn 0.5s ease both; }
    .anim-bounce     { animation: bounce 0.7s ease both; }
    .anim-pulse      { animation: pulse 2s ease-in-out infinite; }
    .anim-float      { animation: float 3s ease-in-out infinite; }
    .anim-clickFade  { cursor: pointer; transition: opacity 0.4s ease, transform 0.4s ease; }
    .anim-clickFade.faded { opacity: 0; transform: scale(0.95); pointer-events: none; }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .drop-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(46,204,113,0.1);
      border: 2px dashed var(--success);
      border-radius: 8px;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--success);
      pointer-events: none;
      z-index: 10;
    }
    .grid-cell.drag-over .drop-overlay { display: flex; }

    /* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æç”» */
    .cell-content.md-rendered h1 { font-size: 1.6em; font-weight: 700; margin: 0.3em 0; line-height: 1.3; }
    .cell-content.md-rendered h2 { font-size: 1.35em; font-weight: 700; margin: 0.3em 0; line-height: 1.3; }
    .cell-content.md-rendered h3 { font-size: 1.15em; font-weight: 700; margin: 0.25em 0; line-height: 1.3; }
    .cell-content.md-rendered h4 { font-size: 1em; font-weight: 700; margin: 0.2em 0; }
    .cell-content.md-rendered p { margin: 0.3em 0; }
    .cell-content.md-rendered strong { font-weight: 700; }
    .cell-content.md-rendered em { font-style: italic; }
    .cell-content.md-rendered code {
      background: rgba(128,128,128,0.2);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    .cell-content.md-rendered pre {
      background: rgba(0,0,0,0.25);
      padding: 8px 10px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 0.4em 0;
      white-space: pre-wrap;
    }
    .cell-content.md-rendered pre code { background: none; padding: 0; border-radius: 0; }
    .cell-content.md-rendered ul, .cell-content.md-rendered ol { padding-left: 1.5em; margin: 0.3em 0; }
    .cell-content.md-rendered li { margin: 0.15em 0; }
    .cell-content.md-rendered blockquote {
      border-left: 3px solid var(--accent, #e94560);
      padding-left: 10px;
      margin: 0.4em 0;
      opacity: 0.85;
    }
    .cell-content.md-rendered hr { border: none; border-top: 1px solid rgba(128,128,128,0.4); margin: 0.5em 0; }
    .cell-content.md-rendered a { color: #5ba8ff; text-decoration: underline; }
    .cell-content.md-rendered img { max-width: 100%; border-radius: 4px; }
    .cell-content.md-rendered { white-space: normal; }
    .cell-content.md-rendered .md-inner { width: 100%; }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */
    .size-marker {
      background: rgba(91, 168, 255, 0.15);
      padding: 0 2px;
      border-radius: 2px;
      white-space: nowrap;
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
      color: var(--text-dim);
    }
    .empty-state .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state p { font-size: 13px; line-height: 1.6; }

    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«å†…ã®ç”»åƒæƒ…å ± */
    .image-info-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-top: 8px;
    }
    .image-info-panel img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 4px;
    }
    .image-info-panel .info {
      flex: 1;
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-dim);
      word-break: break-all;
    }
    .image-info-panel .info .filename {
      color: var(--text);
      font-weight: 500;
    }
    .image-info-panel .info .path {
      font-family: 'Courier New', monospace;
      color: var(--success);
      font-size: 10px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 900px) {
      .editor-body { flex-direction: column; }
      .side-panel { width: 100%; max-height: 300px; border-right: none; border-bottom: 1px solid var(--border); }
    }
    @media (max-width: 768px) {
      .grid-row {
        grid-template-columns: 1fr !important;
        aspect-ratio: auto;
      }
      .grid-cell {
        aspect-ratio: 3 / 1;
      }
    }

    /* Font */
    .font-option-serif { font-family: 'Noto Serif JP', serif; }
    .font-option-sans  { font-family: 'Noto Sans JP', sans-serif; }

    /* ===== ã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ ===== */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .card-cell {
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      outline: 2px solid transparent;
      transition: outline 0.15s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      background: #fff;
    }
    .card-cell:hover { outline-color: rgba(233,69,96,0.4); }
    .card-cell.selected { outline-color: var(--accent); }
    .card-cell .card-image-area {
      flex: 0 0 60%;
      overflow: hidden;
      background: rgba(0,0,0,0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .card-cell .card-image-area img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .card-cell .card-image-area .card-img-placeholder {
      font-size: 32px;
      opacity: 0.2;
    }
    .card-cell .card-text-area {
      flex: 1;
      padding: 12px;
      overflow: hidden;
      display: flex;
      word-break: break-word;
      line-height: 1.5;
    }
    .card-cell .cell-badge {
      position: absolute;
      top: 4px; left: 4px;
      font-size: 9px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 1px 5px;
      border-radius: 3px;
      pointer-events: none;
      opacity: 0.6;
      z-index: 2;
    }
    .card-cell .drop-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(46,204,113,0.1);
      border: 2px dashed var(--success);
      border-radius: 10px;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--success);
      z-index: 3;
    }
    .card-cell.drag-over .drop-overlay { display: flex; }
    .card-cell .image-remove-btn {
      position: absolute;
      top: 4px; right: 4px;
      width: 20px; height: 20px;
      border-radius: 50%;
      border: none;
      background: rgba(231,76,60,0.8);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    .card-cell:hover .image-remove-btn.visible { display: flex; }

    /* ã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ MD */
    .card-text-area.md-rendered { white-space: normal; }
    .card-text-area.md-rendered .md-inner { width: 100%; }
    .card-text-area.md-rendered h1 { font-size: 1.4em; font-weight: 700; margin: 0.2em 0; }
    .card-text-area.md-rendered h2 { font-size: 1.2em; font-weight: 700; margin: 0.2em 0; }
    .card-text-area.md-rendered h3 { font-size: 1.1em; font-weight: 700; margin: 0.15em 0; }
    .card-text-area.md-rendered p { margin: 0.2em 0; }
    .card-text-area.md-rendered strong { font-weight: 700; }
    .card-text-area.md-rendered em { font-style: italic; }
    .card-text-area.md-rendered code { background: rgba(128,128,128,0.2); padding: 1px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
    .card-text-area.md-rendered ul, .card-text-area.md-rendered ol { padding-left: 1.5em; margin: 0.2em 0; }
    .card-text-area.md-rendered li { margin: 0.1em 0; }
    .card-text-area.md-rendered blockquote { border-left: 3px solid #e94560; padding-left: 10px; margin: 0.3em 0; opacity: 0.85; }
    .card-text-area.md-rendered a { color: #5ba8ff; text-decoration: underline; }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="app-header">
    <div class="app-title">
      <span class="icon">âŠ</span> ãƒ–ãƒ­ã‚°ã‚¨ãƒ‡ã‚£ã‚¿
    </div>
    <div class="header-actions">
      <button class="btn" onclick="exportHTML()">ğŸ“„ HTMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </header>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="settings" onclick="switchTab('settings')">âš™ è¨­å®š</button>
    <button class="tab-btn" data-tab="editor" onclick="switchTab('editor')">âœ ã‚¨ãƒ‡ã‚£ã‚¿</button>
  </nav>

  <!-- ========== è¨­å®šã‚¿ãƒ– ========== -->
  <div class="tab-content active" id="tab-settings">
    <div class="settings-page">
      <div class="settings-container">

        <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ -->
        <div class="settings-section">
          <div class="settings-section-title">ğŸ“ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰</div>
          <div class="form-row">
            <div class="toggle-group" id="layoutModeToggle">
              <button class="toggle-btn active" data-val="grid" onclick="switchLayoutMode('grid')">ã‚°ãƒªãƒƒãƒ‰ï¼ˆ3åˆ—ï¼‰</button>
              <button class="toggle-btn" data-val="card" onclick="switchLayoutMode('card')">ã‚«ãƒ¼ãƒ‰</button>
            </div>
          </div>
          <div id="cardSettings" style="display:none; margin-top:12px;">
            <div class="path-row">
              <label>ã‚«ãƒ¼ãƒ‰æšæ•°</label>
              <input type="number" id="cardCount" value="12" min="2" max="48" step="1" style="max-width:80px;" onchange="updateCardCount()" />
            </div>
            <div class="settings-hint">
              ç”»åƒï¼‹çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã®æ­£æ–¹å½¢ã‚«ãƒ¼ãƒ‰ã‚’ä¸¦ã¹ã¾ã™ã€‚PC: 2åˆ—ã€ãƒ¢ãƒã‚¤ãƒ«: 1åˆ—ã§è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚
            </div>
          </div>
        </div>

        <!-- ãƒ‘ã‚¹ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
        <div class="settings-section">
          <div class="settings-section-title">ğŸ“ ç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š</div>
          <p class="settings-hint" style="margin-top:0; margin-bottom:16px;">
            ã‚ˆãä½¿ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä»˜ãã§ç™»éŒ²ã—ã¦ãŠãã¨ã€ã‚¨ãƒ‡ã‚£ã‚¿ã§ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸéš›ã«è‡ªå‹•ã§ãƒ‘ã‚¹ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
          </p>

          <div class="path-row">
            <label>ã‚¨ã‚¤ãƒªã‚¢ã‚¹å</label>
            <input type="text" id="newAlias" placeholder="ä¾‹: post-img" style="max-width:140px;" />
          </div>
          <div class="path-row">
            <label>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹</label>
            <input type="text" id="newPath" placeholder="ä¾‹: /images/posts/" />
            <button class="btn btn-primary btn-sm" onclick="addPathPreset()">è¿½åŠ </button>
          </div>
          <div class="settings-hint">
            ãƒ‘ã‚¹ã®æœ«å°¾ã« <code style="background:rgba(255,255,255,0.1);padding:1px 5px;border-radius:3px;">/</code> ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚ç›¸å¯¾ãƒ‘ã‚¹ãƒ»ãƒ«ãƒ¼ãƒˆç›¸å¯¾ãƒ‘ã‚¹ãƒ»URLã„ãšã‚Œã‚‚ä½¿ãˆã¾ã™ã€‚
          </div>

          <div class="path-list" id="pathList"></div>
        </div>

        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š -->
        <div class="settings-section">
          <div class="settings-section-title">ğŸ¯ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹</div>
          <p class="settings-hint" style="margin-top:0; margin-bottom:12px;">
            ã‚¨ãƒ‡ã‚£ã‚¿ã§ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸæ™‚ã«ã©ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ã†ã‹ã‚’é¸æŠã—ã¾ã™ã€‚
          </p>
          <div class="path-row">
            <label>ä½¿ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</label>
            <select id="defaultPathSelect" onchange="saveSettings()" style="font-family:'Courier New',monospace;"></select>
          </div>
        </div>

        <!-- èƒŒæ™¯ç”»åƒ -->
        <div class="settings-section">
          <div class="settings-section-title">ğŸ–¼ èƒŒæ™¯ç”»åƒ</div>
          <div class="path-row">
            <label>èƒŒæ™¯ç”»åƒãƒ‘ã‚¹</label>
            <input type="text" id="bgPath" placeholder="ä¾‹: /images/bg/hero.jpg" oninput="saveSettings()" />
          </div>
          <div class="settings-hint">
            ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«å›ºå®šèƒŒæ™¯ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚ç©ºæ¬„ã®å ´åˆã¯èƒŒæ™¯ãªã—ã€‚
          </div>
        </div>

        <!-- ãƒšãƒ¼ã‚¸èƒŒæ™¯è‰² -->
        <div class="settings-section">
          <div class="settings-section-title">ğŸ¨ ãƒšãƒ¼ã‚¸èƒŒæ™¯è‰²</div>
          <div class="path-row">
            <label>èƒŒæ™¯è‰²</label>
            <input type="color" id="pageBgColor" value="#f5f5f5" oninput="applyPageBgColor(this.value); saveSettings();" style="max-width:80px; height:34px;" />
            <span id="pageBgColorHex" style="font-family:'Courier New',monospace; font-size:13px; color:var(--text-dim);">#f5f5f5</span>
            <button class="btn btn-sm" onclick="document.getElementById('pageBgColor').value='#f5f5f5'; applyPageBgColor('#f5f5f5'); saveSettings();">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div class="settings-hint">
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ä¸¡æ–¹ã«åæ˜ ã•ã‚Œã¾ã™ã€‚æš—ã„èƒŒæ™¯ã«ã™ã‚‹ã¨ã‚°ãƒ­ãƒ¼ç­‰ã®ç™ºå…‰ç³»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæ˜ ãˆã¾ã™ã€‚
          </div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š -->
        <div class="settings-section">
          <div class="settings-section-title">ğŸ“„ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š</div>
          <div class="path-row">
            <label>ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="exportTitle" placeholder="ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«" oninput="saveSettings()" />
          </div>
          <div class="path-row">
            <label>CSSèª­è¾¼ãƒ‘ã‚¹</label>
            <input type="text" id="exportCssPath" placeholder="ä¾‹: /css/blog.cssï¼ˆç©ºæ¬„=ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰" oninput="saveSettings()" />
          </div>
        </div>

        <div style="text-align:center; padding:16px;">
          <span class="save-indicator" id="saveIndicator">âœ“ è‡ªå‹•ä¿å­˜æ¸ˆã¿</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ– ========== -->
  <div class="tab-content" id="tab-editor">
    <div class="editor-body">
      <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
      <aside class="side-panel" id="sidePanel">

        <!-- ç¾åœ¨ã®ãƒ‘ã‚¹è¡¨ç¤º -->
        <div class="panel-section" style="padding:10px 16px; background:rgba(46,204,113,0.08);">
          <div style="font-size:11px; color:var(--text-dim); margin-bottom:2px;">ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—å…ˆ</div>
          <div style="font-family:'Courier New',monospace; font-size:13px; color:var(--success);" id="currentPathDisplay">/images/</div>
          <div style="font-size:10px; color:var(--text-dim); margin-top:4px;">
            ã‚»ãƒ«ã«ç”»åƒã‚’D&amp;Dã™ã‚‹ã¨è‡ªå‹•ã§ãƒ‘ã‚¹ãŒè¨­å®šã•ã‚Œã¾ã™
          </div>
        </div>

        <!-- ã‚»ãƒ«ç·¨é›†ãƒ‘ãƒãƒ« -->
        <div id="cellEditor" style="display:none;">
          <div class="panel-section">
            <div class="panel-label" id="cellEditorTitle">ğŸ“ ã‚»ãƒ«ç·¨é›†</div>

            <!-- ç”»åƒãŒã‚ã‚‹å ´åˆã®æƒ…å ± -->
            <div id="cellImageInfo" style="display:none;">
              <div class="image-info-panel">
                <img id="cellImageThumb" src="" alt="" />
                <div class="info">
                  <div class="filename" id="cellImageName"></div>
                  <div class="path" id="cellImagePath"></div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="removeCellImage()">âœ•</button>
              </div>
            </div>

            <div class="form-row" style="margin-top:8px;">
              <label>ãƒ†ã‚­ã‚¹ãƒˆ</label>
              <textarea class="cell-text-input" id="cellText" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦"></textarea>
            </div>

            <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºå¤‰æ›´ãƒ„ãƒ¼ãƒ« -->
            <div id="textSizeTools" style="display:none; margin-top:8px; padding:8px; background:var(--bg-primary); border-radius:6px;">
              <div style="font-size:11px; color:var(--text-dim); margin-bottom:6px;">é¸æŠãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºå¤‰æ›´</div>
              <div style="display:flex; gap:4px; flex-wrap:wrap;">
                <button class="btn btn-sm" onclick="changeFontSizeOfSelection(0.8)" title="70% ã«ç¸®å°">ğŸ” å°</button>
                <button class="btn btn-sm" onclick="changeFontSizeOfSelection(1.0)" title="ãƒªã‚»ãƒƒãƒˆ">â†º æ¨™æº–</button>
                <button class="btn btn-sm" onclick="changeFontSizeOfSelection(1.2)" title="120% ã«æ‹¡å¤§">ğŸ” å¤§</button>
                <button class="btn btn-sm" onclick="changeFontSizeOfSelection(1.5)" title="150% ã«æ‹¡å¤§">ğŸ” ç‰¹å¤§</button>
              </div>
              <div style="font-size:10px; color:var(--text-dim); margin-top:6px; line-height:1.4;">
                <code style="background:rgba(255,255,255,0.1);padding:1px 3px;">{ãƒ†ã‚­ã‚¹ãƒˆ|0.8}</code> ã§å°ã•ãã€<code style="background:rgba(255,255,255,0.1);padding:1px 3px;">{ãƒ†ã‚­ã‚¹ãƒˆ|1.5}</code> ã§å¤§ããã—ã¾ã™
              </div>
            </div>

            <div class="form-row">
              <label>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
              <div class="toggle-group" id="inputMode">
                <button class="toggle-btn active" data-val="plain">ãƒ—ãƒ¬ãƒ¼ãƒ³</button>
                <button class="toggle-btn" data-val="md">ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³</button>
              </div>
            </div>
            <div id="mdHelp" style="display:none; margin-top:6px; font-size:11px; color:var(--text-dim); line-height:1.5; padding:6px 8px; background:var(--bg-primary); border-radius:5px;">
              <b># è¦‹å‡ºã—</b>ã€€<b>**å¤ªå­—**</b>ã€€<b>*æ–œä½“*</b><br>
              <b>- ãƒªã‚¹ãƒˆ</b>ã€€<b>1. ç•ªå·ãƒªã‚¹ãƒˆ</b><br>
              <b>`ã‚³ãƒ¼ãƒ‰`</b>ã€€<b>> å¼•ç”¨</b>ã€€<b>---</b><br>
              <b>[ãƒªãƒ³ã‚¯](URL)</b>ã€€<b>![ç”»åƒ](URL)</b><br>
              <b>{ãƒ†ã‚­ã‚¹ãƒˆ|1.5}</b> ã‚µã‚¤ã‚ºã€€<b>{æ¼¢å­—|ã‹ã‚“ã˜}</b> ãƒ«ãƒ“
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-label">æ–‡å­—æ–¹å‘</div>
            <div class="form-row">
              <div class="toggle-group" id="writingMode">
                <button class="toggle-btn active" data-val="h">æ¨ªæ›¸ã</button>
                <button class="toggle-btn" data-val="v">ç¸¦æ›¸ã</button>
              </div>
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-label">é…ç½®</div>
            <div class="form-row">
              <label>æ¨ªæƒãˆ</label>
              <div class="toggle-group" id="hAlign">
                <button class="toggle-btn active" data-val="left">å·¦</button>
                <button class="toggle-btn" data-val="center">ä¸­å¤®</button>
                <button class="toggle-btn" data-val="right">å³</button>
              </div>
            </div>
            <div class="form-row" style="margin-top:8px;">
              <label>ç¸¦æƒãˆ</label>
              <div class="toggle-group" id="vAlign">
                <button class="toggle-btn" data-val="top">ä¸Š</button>
                <button class="toggle-btn active" data-val="middle">ä¸­å¤®</button>
                <button class="toggle-btn" data-val="bottom">ä¸‹</button>
              </div>
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-label">ãƒ•ã‚©ãƒ³ãƒˆ</div>
            <div class="form-row">
              <label>æ›¸ä½“</label>
              <select id="fontFamily">
                <option value="'Noto Sans JP', sans-serif">ã‚´ã‚·ãƒƒã‚¯ä½“</option>
                <option value="'Noto Serif JP', serif">æ˜æœä½“</option>
              </select>
            </div>
            <div class="form-row">
              <label>ã‚µã‚¤ã‚º (px)</label>
              <input type="number" id="fontSize" value="16" min="8" max="120" step="1" />
            </div>
            <div class="form-row">
              <label>å¤ªã•</label>
              <select id="fontWeight">
                <option value="300">Light</option>
                <option value="400" selected>Regular</option>
                <option value="500">Medium</option>
                <option value="700">Bold</option>
              </select>
            </div>
            <div class="form-row">
              <label>æ–‡å­—è‰²</label>
              <input type="color" id="fontColor" value="#333333" />
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-label">ğŸ¨ è£…é£¾</div>
            <div class="form-row">
              <label>èƒŒæ™¯è‰²ï¼ˆç©º=é€æ˜ï¼‰</label>
              <div style="display:flex; gap:6px; align-items:center;">
                <input type="color" id="cellBgColor" value="#ffffff" style="flex:1;" />
                <button class="btn btn-sm" onclick="document.getElementById('cellBgColor').value='#ffffff'; if(selectedIdx>=0){cellData[selectedIdx].bgColor='';renderCell(selectedIdx);}">ã‚¯ãƒªã‚¢</button>
              </div>
            </div>
            <div class="form-row">
              <label>èƒŒæ™¯ã®ä¸é€æ˜åº¦: <span id="bgOpacityVal">100</span>%</label>
              <input type="range" id="cellBgOpacity" min="0" max="100" value="100" style="width:100%;" />
            </div>
            <div class="form-row">
              <label>è§’ä¸¸ (px): <span id="borderRadiusVal">10</span></label>
              <input type="range" id="cellBorderRadius" min="0" max="50" value="10" style="width:100%;" />
            </div>
            <div class="form-row">
              <label>å½±</label>
              <select id="cellShadow">
                <option value="none">ãªã—</option>
                <option value="sm">å°ã•ã„å½±</option>
                <option value="md">ä¸­ãã‚‰ã„ã®å½±</option>
                <option value="lg">å¤§ãã„å½±</option>
                <option value="glow">ã‚°ãƒ­ãƒ¼ï¼ˆç™ºå…‰ï¼‰</option>
                <option value="hard">ãƒãƒ¼ãƒ‰ã‚·ãƒ£ãƒ‰ã‚¦</option>
              </select>
            </div>
            <div class="form-row" id="glowColorRow" style="display:none;">
              <label>ç™ºå…‰è‰²</label>
              <input type="color" id="cellGlowColor" value="#e94560" />
            </div>
            <div class="form-row">
              <label>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</label>
              <select id="cellAnimation">
                <option value="none">ãªã—</option>
                <option value="fadeIn">ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³</option>
                <option value="slideUp">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—</option>
                <option value="slideLeft">ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆå·¦ã‹ã‚‰ï¼‰</option>
                <option value="slideRight">ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆå³ã‹ã‚‰ï¼‰</option>
                <option value="zoomIn">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³</option>
                <option value="bounce">ãƒã‚¦ãƒ³ã‚¹</option>
                <option value="pulse">ãƒ‘ãƒ«ã‚¹ï¼ˆç¹°ã‚Šè¿”ã—ï¼‰</option>
                <option value="float">ãµã‚ãµã‚ï¼ˆç¹°ã‚Šè¿”ã—ï¼‰</option>
                <option value="clickFade">ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ</option>
              </select>
              <div style="margin-top:6px;">
                <button class="btn btn-sm" onclick="previewAnimation()">â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
              </div>
            </div>
          </div>
        </div>

        <!-- æœªé¸æŠæ™‚ -->
        <div id="emptyEditor" class="panel-section">
          <div class="empty-state">
            <div class="icon">ğŸ–¼</div>
            <p>ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†<br>ã¾ãŸã¯ç”»åƒã‚’D&amp;Dã§é…ç½®</p>
          </div>
        </div>
      </aside>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <main class="preview-area" id="previewArea">
        <div class="preview-wrapper">
          <div class="grid-container" id="gridContainer"></div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ============================================================
    //  è¨­å®šç®¡ç†
    // ============================================================
    const DEFAULT_SETTINGS = {
      pathPresets: [
        { alias: 'post-img', path: '/images/posts/' },
        { alias: 'bg', path: '/images/bg/' },
        { alias: 'icons', path: '/images/icons/' },
      ],
      defaultPathIndex: 0,
      bgPath: '',
      pageBgColor: '#f5f5f5',
      layoutMode: 'grid',
      cardCount: 12,
      exportTitle: '',
      exportCssPath: '',
    };

    let settings = loadSettings();

    function loadSettings() {
      try {
        const raw = localStorage.getItem('blogEditorSettings');
        if (raw) return { ...DEFAULT_SETTINGS, ...JSON.parse(raw) };
      } catch(e) {}
      return { ...DEFAULT_SETTINGS, pathPresets: [...DEFAULT_SETTINGS.pathPresets.map(p => ({...p}))] };
    }

    function saveSettings() {
      settings.bgPath = document.getElementById('bgPath').value;
      settings.pageBgColor = document.getElementById('pageBgColor').value;
      settings.exportTitle = document.getElementById('exportTitle').value;
      settings.exportCssPath = document.getElementById('exportCssPath').value;
      settings.cardCount = parseInt(document.getElementById('cardCount').value) || 12;
      const sel = document.getElementById('defaultPathSelect');
      settings.defaultPathIndex = parseInt(sel.value) || 0;
      localStorage.setItem('blogEditorSettings', JSON.stringify(settings));
      showSaveIndicator();
      updateCurrentPathDisplay();
    }

    function applyPageBgColor(color) {
      document.getElementById('previewArea').style.background = color;
      document.getElementById('pageBgColorHex').textContent = color;
    }

    function showSaveIndicator() {
      const el = document.getElementById('saveIndicator');
      el.classList.add('show');
      clearTimeout(el._timer);
      el._timer = setTimeout(() => el.classList.remove('show'), 2000);
    }

    function renderPathList() {
      const list = document.getElementById('pathList');
      const sel = document.getElementById('defaultPathSelect');
      list.innerHTML = '';
      sel.innerHTML = '';

      settings.pathPresets.forEach((p, i) => {
        const item = document.createElement('div');
        item.className = 'path-item';
        item.innerHTML = `
          <span class="path-alias">${escHTML(p.alias)}</span>
          <span class="path-value">${escHTML(p.path)}</span>
          <button class="btn btn-danger btn-sm" onclick="removePathPreset(${i})">âœ•</button>
        `;
        list.appendChild(item);

        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${p.alias}  â†’  ${p.path}`;
        if (i === settings.defaultPathIndex) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function addPathPreset() {
      const alias = document.getElementById('newAlias').value.trim();
      let path = document.getElementById('newPath').value.trim();
      if (!alias || !path) return;
      if (!path.endsWith('/')) path += '/';
      settings.pathPresets.push({ alias, path });
      document.getElementById('newAlias').value = '';
      document.getElementById('newPath').value = '';
      renderPathList();
      saveSettings();
    }

    function removePathPreset(idx) {
      settings.pathPresets.splice(idx, 1);
      if (settings.defaultPathIndex >= settings.pathPresets.length) {
        settings.defaultPathIndex = Math.max(0, settings.pathPresets.length - 1);
      }
      renderPathList();
      saveSettings();
    }

    function getDefaultPath() {
      if (settings.pathPresets.length === 0) return '/images/';
      const idx = Math.min(settings.defaultPathIndex, settings.pathPresets.length - 1);
      return settings.pathPresets[idx].path;
    }

    function updateCurrentPathDisplay() {
      const el = document.getElementById('currentPathDisplay');
      if (el) el.textContent = getDefaultPath();
    }

    // ============================================================
    //  ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    // ============================================================
    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === `tab-${tabId}`));
      if (tabId === 'editor') updateCurrentPathDisplay();
    }

    // ============================================================
    //  ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿
    // ============================================================
    const ROWS = 36;
    const COLS = 3;
    const cellData = [];
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        cellData.push({
          row: r, col: c,
          text: '',
          inputMode: 'plain',
          writingMode: 'h',
          hAlign: 'left',
          vAlign: 'middle',
          fontFamily: "'Noto Sans JP', sans-serif",
          fontSize: 16,
          fontWeight: '400',
          fontColor: '#333333',
          bgColor: '',
          bgOpacity: 100,
          borderRadius: 10,
          shadow: 'none',
          glowColor: '#e94560',
          animation: 'none',
          image: null,
        });
      }
    }

    let selectedIdx = -1;

    function buildGrid() {
      const container = document.getElementById('gridContainer');
      container.innerHTML = '';
      deselectCell();

      if (settings.layoutMode === 'card') {
        container.className = 'card-grid';
        const count = settings.cardCount || 12;
        for (let i = 0; i < count; i++) {
          const cell = document.createElement('div');
          cell.className = 'card-cell';
          cell.dataset.idx = i;
          cell.onclick = (e) => { if (!e.target.closest('.image-remove-btn')) selectCell(i); };

          const badge = document.createElement('div');
          badge.className = 'cell-badge';
          badge.textContent = `${i+1}`;

          const dropOverlay = document.createElement('div');
          dropOverlay.className = 'drop-overlay';
          dropOverlay.textContent = 'ğŸ“· ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—';

          const imgArea = document.createElement('div');
          imgArea.className = 'card-image-area';
          imgArea.id = `card-img-${i}`;
          const placeholder = document.createElement('div');
          placeholder.className = 'card-img-placeholder';
          placeholder.textContent = 'ğŸ–¼';
          imgArea.appendChild(placeholder);

          const removeBtn = document.createElement('button');
          removeBtn.className = 'image-remove-btn';
          removeBtn.textContent = 'âœ•';
          removeBtn.id = `img-remove-${i}`;
          removeBtn.onclick = (e) => { e.stopPropagation(); removeCellImageAt(i); };

          const textArea = document.createElement('div');
          textArea.className = 'card-text-area';
          textArea.id = `content-${i}`;

          cell.appendChild(badge);
          cell.appendChild(dropOverlay);
          cell.appendChild(imgArea);
          cell.appendChild(removeBtn);
          cell.appendChild(textArea);
          container.appendChild(cell);

          cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drag-over'); });
          cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
          cell.addEventListener('drop', (e) => {
            e.preventDefault();
            cell.classList.remove('drag-over');
            handleImageDrop(i, e.dataTransfer);
          });
        }
        renderAll();
        return;
      }

      container.className = 'grid-container';
      for (let r = 0; r < ROWS; r++) {
        const row = document.createElement('div');
        row.className = 'grid-row';
        for (let c = 0; c < COLS; c++) {
          const idx = r * COLS + c;
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          cell.dataset.idx = idx;
          cell.onclick = (e) => { if (!e.target.closest('.image-remove-btn')) selectCell(idx); };

          const badge = document.createElement('div');
          badge.className = 'cell-badge';
          badge.textContent = `${r+1}-${c+1}`;

          const mdBadge = document.createElement('div');
          mdBadge.className = 'md-badge';
          mdBadge.id = `md-badge-${idx}`;
          mdBadge.textContent = 'MD';
          mdBadge.style.display = 'none';

          const content = document.createElement('div');
          content.className = 'cell-content';
          content.id = `content-${idx}`;

          const dropOverlay = document.createElement('div');
          dropOverlay.className = 'drop-overlay';
          dropOverlay.textContent = 'ğŸ“· ãƒ‰ãƒ­ãƒƒãƒ—ã§ç”»åƒé…ç½®';

          const imgBadge = document.createElement('div');
          imgBadge.className = 'image-badge';
          imgBadge.id = `img-badge-${idx}`;
          imgBadge.style.display = 'none';

          const removeBtn = document.createElement('button');
          removeBtn.className = 'image-remove-btn';
          removeBtn.textContent = 'âœ•';
          removeBtn.id = `img-remove-${idx}`;
          removeBtn.style.display = 'none';
          removeBtn.onclick = (e) => { e.stopPropagation(); removeCellImageAt(idx); };

          cell.appendChild(badge);
          cell.appendChild(mdBadge);
          cell.appendChild(dropOverlay);
          cell.appendChild(content);
          cell.appendChild(imgBadge);
          cell.appendChild(removeBtn);
          row.appendChild(cell);

          cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drag-over'); });
          cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
          cell.addEventListener('drop', (e) => {
            e.preventDefault();
            cell.classList.remove('drag-over');
            handleImageDrop(idx, e.dataTransfer);
          });
        }
        container.appendChild(row);
      }
    }

    // ===== ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç† =====
    function handleImageDrop(idx, dataTransfer) {
      const files = dataTransfer.files;
      if (files.length === 0) return;
      const file = files[0];
      if (!file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const basePath = getDefaultPath();
        cellData[idx].image = {
          filename: file.name,
          exportPath: basePath + file.name,
          previewDataUrl: e.target.result,
        };
        renderCell(idx);
        selectCell(idx);
      };
      reader.readAsDataURL(file);
    }

    function removeCellImageAt(idx) {
      cellData[idx].image = null;
      const cell = document.querySelector(`.grid-cell[data-idx="${idx}"]`);
      if (cell) cell.classList.remove('has-image');
      renderCell(idx);
      if (selectedIdx === idx) selectCell(idx);
    }

    function removeCellImage() {
      if (selectedIdx >= 0) removeCellImageAt(selectedIdx);
    }

    // ===== ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºå¤‰æ›´ =====
    function changeFontSizeOfSelection(ratio) {
      const textarea = document.getElementById('cellText');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      
      if (start === end) {
        alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const selectedText = textarea.value.substring(start, end);
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      
      const sizeMarked = `{${selectedText}|${ratio}}`;
      textarea.value = before + sizeMarked + after;
      
      if (selectedIdx >= 0) {
        cellData[selectedIdx].text = textarea.value;
        renderCell(selectedIdx);
      }
      
      textarea.focus();
      textarea.selectionStart = start;
      textarea.selectionEnd = start + sizeMarked.length;
    }

    // ===== ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚µã‚¤ã‚ºå¯¾å¿œï¼‰ =====
    function parseMDWithSize(src) {
      const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      let html = '';
      const lines = src.split('\n');
      let i = 0;
      let inUl = false, inOl = false;

      function closeList() {
        if (inUl) { html += '</ul>'; inUl = false; }
        if (inOl) { html += '</ol>'; inOl = false; }
      }

      function inlineMarkup(text) {
        text = esc(text);
        text = text.replace(/\{([^|{}]+)\|([0-9.]+)\}/g, '<span class="size-marker" style="font-size:$2em">$1</span>');
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" />');
        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
        text = text.replace(/~~(.+?)~~/g, '<del>$1</del>');
        text = text.replace(/\{([^|{}]+)\|([^|{}]+)\}/g, '<ruby>$1<rt>$2</rt></ruby>');
        return text;
      }

      while (i < lines.length) {
        const line = lines[i];
        if (line.trimStart().startsWith('```')) {
          closeList(); let code = ''; i++;
          while (i < lines.length && !lines[i].trimStart().startsWith('```')) { code += (code ? '\n' : '') + esc(lines[i]); i++; }
          html += `<pre><code>${code}</code></pre>`; i++; continue;
        }
        const hm = line.match(/^(#{1,4})\s+(.+)/);
        if (hm) { closeList(); html += `<h${hm[1].length}>${inlineMarkup(hm[2])}</h${hm[1].length}>`; i++; continue; }
        if (/^(---|\*\*\*|___)\s*$/.test(line.trim())) { closeList(); html += '<hr>'; i++; continue; }
        if (line.trimStart().startsWith('> ')) {
          closeList(); let bq = '';
          while (i < lines.length && lines[i].trimStart().startsWith('> ')) { bq += (bq ? '<br>' : '') + inlineMarkup(lines[i].replace(/^>\s?/, '')); i++; }
          html += `<blockquote>${bq}</blockquote>`; continue;
        }
        const ulM = line.match(/^[\s]*([-*+])\s+(.+)/);
        if (ulM) { if (inOl) { html += '</ol>'; inOl = false; } if (!inUl) { html += '<ul>'; inUl = true; } html += `<li>${inlineMarkup(ulM[2])}</li>`; i++; continue; }
        const olM = line.match(/^[\s]*(\d+)[.)]\s+(.+)/);
        if (olM) { if (inUl) { html += '</ul>'; inUl = false; } if (!inOl) { html += '<ol>'; inOl = true; } html += `<li>${inlineMarkup(olM[2])}</li>`; i++; continue; }
        if (line.trim() === '') { closeList(); i++; continue; }
        closeList();
        let paraLines = [];
        while (i < lines.length && lines[i].trim() !== '' &&
               !lines[i].match(/^(#{1,4})\s+/) &&
               !lines[i].trimStart().startsWith('```') &&
               !/^(---|\*\*\*|___)\s*$/.test(lines[i].trim()) &&
               !lines[i].trimStart().startsWith('> ') &&
               !lines[i].match(/^[\s]*([-*+])\s+/) &&
               !lines[i].match(/^[\s]*(\d+)[.)]\s+/)) {
          paraLines.push(inlineMarkup(lines[i]));
          i++;
        }
        html += `<p>${paraLines.join('<br>')}</p>`;
      }
      closeList();
      return html;
    }

    // ===== ã‚»ãƒ«æç”» =====
    function getShadowValue(key, glowColor) {
      if (key === 'glow') {
        const c = glowColor || '#e94560';
        const r = parseInt(c.slice(1,3),16), g = parseInt(c.slice(3,5),16), b = parseInt(c.slice(5,7),16);
        return `0 0 25px rgba(${r},${g},${b},0.5), 0 0 60px rgba(${r},${g},${b},0.3), 0 0 100px rgba(${r},${g},${b},0.15)`;
      }
      const map = {
        none: 'none',
        sm: '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08)',
        md: '0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1)',
        lg: '0 10px 30px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.1)',
        hard: '5px 5px 0px rgba(0,0,0,0.2)',
      };
      return map[key] || 'none';
    }

    function hexToRgba(hex, opacity) {
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
      return `rgba(${r},${g},${b},${opacity/100})`;
    }

    function renderCell(idx) {
      const d = cellData[idx];

      if (settings.layoutMode === 'card') {
        const cell = document.querySelector(`.card-cell[data-idx="${idx}"]`);
        if (!cell) return;
        const imgArea = document.getElementById(`card-img-${idx}`);
        const textArea = document.getElementById(`content-${idx}`);
        const removeBtn = document.getElementById(`img-remove-${idx}`);

        cell.style.borderRadius = (d.borderRadius ?? 12) + 'px';
        cell.style.boxShadow = getShadowValue(d.shadow || 'none', d.glowColor);
        if (d.bgColor) {
          cell.style.background = hexToRgba(d.bgColor, d.bgOpacity ?? 100);
        } else {
          cell.style.background = '#fff';
        }
        cell.className = cell.className.replace(/\banim-\S+/g, '').trim();
        if (!cell.classList.contains('card-cell')) cell.classList.add('card-cell');
        if (d.animation && d.animation !== 'none') cell.classList.add('anim-' + d.animation);

        if (d.image) {
          imgArea.innerHTML = `<img src="${d.image.previewDataUrl}" alt="${escHTML(d.image.filename)}" />`;
          if (removeBtn) { removeBtn.classList.add('visible'); }
        } else {
          imgArea.innerHTML = '<div class="card-img-placeholder">ğŸ–¼</div>';
          if (removeBtn) { removeBtn.classList.remove('visible'); }
        }

        textArea.style.fontFamily = d.fontFamily;
        textArea.style.fontSize = d.fontSize + 'px';
        textArea.style.fontWeight = d.fontWeight;
        textArea.style.color = d.fontColor;
        if (d.inputMode === 'md' && d.text.trim()) {
          textArea.className = 'card-text-area md-rendered';
          textArea.innerHTML = `<div class="md-inner">${parseMDWithSize(d.text)}</div>`;
        } else {
          textArea.className = 'card-text-area';
          textArea.textContent = d.text;
        }
        return;
      }

      const el = document.getElementById(`content-${idx}`);
      const mdBadge = document.getElementById(`md-badge-${idx}`);
      const imgBadge = document.getElementById(`img-badge-${idx}`);
      const imgRemove = document.getElementById(`img-remove-${idx}`);
      const cell = document.querySelector(`.grid-cell[data-idx="${idx}"]`);
      if (!el) return;

      cell.style.borderRadius = (d.borderRadius ?? 10) + 'px';
      cell.style.boxShadow = getShadowValue(d.shadow || 'none', d.glowColor);
      if (d.bgColor) {
        cell.style.background = hexToRgba(d.bgColor, d.bgOpacity ?? 100);
      } else {
        cell.style.background = 'transparent';
      }
      cell.className = cell.className.replace(/\banim-\S+/g, '').trim();
      if (!cell.classList.contains('grid-cell')) cell.classList.add('grid-cell');
      if (d.animation && d.animation !== 'none') {
        cell.classList.add('anim-' + d.animation);
      }

      if (d.image) {
        cell.classList.add('has-image');
        el.innerHTML = `<img src="${d.image.previewDataUrl}" alt="${escHTML(d.image.filename)}" />`;
        el.className = 'cell-content';
        if (imgBadge) { imgBadge.textContent = d.image.filename; imgBadge.style.display = ''; }
        if (imgRemove) imgRemove.style.display = '';
        if (mdBadge) mdBadge.style.display = 'none';
        return;
      }

      cell.classList.remove('has-image');
      if (imgBadge) imgBadge.style.display = 'none';
      if (imgRemove) imgRemove.style.display = 'none';

      el.className = 'cell-content';
      el.classList.add(d.writingMode === 'v' ? 'v-write' : 'h-write');
      el.classList.add(`align-${d.hAlign}`);
      el.classList.add(`valign-${d.vAlign}`);
      el.style.fontFamily = d.fontFamily;
      el.style.fontSize = d.fontSize + 'px';
      el.style.fontWeight = d.fontWeight;
      el.style.color = d.fontColor;

      if (d.inputMode === 'md' && d.text.trim()) {
        el.classList.add('md-rendered');
        el.innerHTML = `<div class="md-inner">${parseMDWithSize(d.text)}</div>`;
        if (mdBadge) mdBadge.style.display = '';
      } else {
        el.textContent = d.text;
        if (mdBadge) mdBadge.style.display = 'none';
      }
    }

    function renderAll() {
      if (settings.layoutMode === 'card') {
        const count = settings.cardCount || 12;
        for (let i = 0; i < count; i++) renderCell(i);
      } else {
        cellData.forEach((_, i) => renderCell(i));
      }
    }

    // ===== ã‚»ãƒ«é¸æŠ =====
    function selectCell(idx) {
      const cellSelector = settings.layoutMode === 'card' ? '.card-cell' : '.grid-cell';
      document.querySelectorAll(`${cellSelector}.selected`).forEach(el => el.classList.remove('selected'));
      selectedIdx = idx;
      const cell = document.querySelector(`${cellSelector}[data-idx="${idx}"]`);
      if (cell) cell.classList.add('selected');

      const d = cellData[idx];
      document.getElementById('cellEditor').style.display = '';
      document.getElementById('emptyEditor').style.display = 'none';
      document.getElementById('cellEditorTitle').textContent = settings.layoutMode === 'card'
        ? `ğŸ“ ã‚«ãƒ¼ãƒ‰ ${idx+1}` : `ğŸ“ ã‚»ãƒ« ${d.row+1}-${d.col+1}`;

      const imgInfo = document.getElementById('cellImageInfo');
      if (d.image) {
        imgInfo.style.display = '';
        document.getElementById('cellImageThumb').src = d.image.previewDataUrl;
        document.getElementById('cellImageName').textContent = d.image.filename;
        document.getElementById('cellImagePath').textContent = d.image.exportPath;
      } else {
        imgInfo.style.display = 'none';
      }

      document.getElementById('cellText').value = d.text;
      setToggle('inputMode', d.inputMode);
      setToggle('writingMode', d.writingMode);
      setToggle('hAlign', d.hAlign);
      setToggle('vAlign', d.vAlign);
      document.getElementById('fontFamily').value = d.fontFamily;
      document.getElementById('fontSize').value = d.fontSize;
      document.getElementById('fontWeight').value = d.fontWeight;
      document.getElementById('fontColor').value = d.fontColor;

      document.getElementById('cellBgColor').value = d.bgColor || '#ffffff';
      document.getElementById('cellBgOpacity').value = d.bgOpacity ?? 100;
      document.getElementById('bgOpacityVal').textContent = d.bgOpacity ?? 100;
      document.getElementById('cellBorderRadius').value = d.borderRadius ?? 10;
      document.getElementById('borderRadiusVal').textContent = d.borderRadius ?? 10;
      document.getElementById('cellShadow').value = d.shadow || 'none';
      document.getElementById('cellGlowColor').value = d.glowColor || '#e94560';
      document.getElementById('glowColorRow').style.display = d.shadow === 'glow' ? '' : 'none';
      document.getElementById('cellAnimation').value = d.animation || 'none';

      const isMarkdown = d.inputMode === 'md';
      document.getElementById('textSizeTools').style.display = isMarkdown ? '' : 'none';
      document.getElementById('mdHelp').style.display = isMarkdown ? '' : 'none';
      document.getElementById('cellText').placeholder = isMarkdown
        ? '# è¦‹å‡ºã—\n**å¤ªå­—** *æ–œä½“*\n- ãƒªã‚¹ãƒˆé …ç›®\n{ãƒ†ã‚­ã‚¹ãƒˆ|1.5} ã§å¤§ãã' : 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦';
      document.getElementById('cellText').focus();
    }

    function deselectCell() {
      document.querySelectorAll('.grid-cell.selected, .card-cell.selected').forEach(el => el.classList.remove('selected'));
      selectedIdx = -1;
      document.getElementById('cellEditor').style.display = 'none';
      document.getElementById('emptyEditor').style.display = '';
    }

    // ===== ãƒˆã‚°ãƒ«ã‚°ãƒ«ãƒ¼ãƒ— =====
    function setToggle(groupId, val) {
      document.querySelectorAll(`#${groupId} .toggle-btn`).forEach(b => b.classList.toggle('active', b.dataset.val === val));
    }

    function initToggleGroup(groupId, field) {
      document.querySelectorAll(`#${groupId} .toggle-btn`).forEach(b => {
        b.onclick = () => {
          document.querySelectorAll(`#${groupId} .toggle-btn`).forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          if (selectedIdx >= 0) { cellData[selectedIdx][field] = b.dataset.val; renderCell(selectedIdx); }
        };
      });
    }

    function bindInput(elId, field, transform) {
      const el = document.getElementById(elId);
      const evt = el.tagName === 'TEXTAREA' ? 'input' : 'change';
      el.addEventListener(evt, () => {
        if (selectedIdx < 0) return;
        cellData[selectedIdx][field] = transform ? transform(el.value) : el.value;
        renderCell(selectedIdx);
      });
    }

    // ===== HTMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ä½¿ç”¨ï¼‰ =====
    function exportHTML() {
      if (settings.layoutMode === 'card') return exportCardHTML();
      return exportGridHTML();
    }

    function exportCardHTML() {
      const bgExportPath = settings.bgPath || '';
      const title = settings.exportTitle || 'ãƒ–ãƒ­ã‚°è¨˜äº‹';
      let bgCSS = '';
      if (bgExportPath) {
        bgCSS = '\n    .bg-layer { position:fixed; top:0; left:0; right:0; bottom:0;'
          + ' background-image:url(' + bgExportPath + ');'
          + ' background-size:cover; background-position:center; background-attachment:fixed; z-index:0; }';
      }

      let cardsHTML = '';
      const count = settings.cardCount || 12;
      for (let i = 0; i < count; i++) {
        const d = cellData[i];
        if (!d.image && !d.text.trim()) continue;

        let cardStyle = '';
        if (d.bgColor) cardStyle += 'background:' + hexToRgba(d.bgColor, d.bgOpacity ?? 100) + ';';
        else cardStyle += 'background:#fff;';
        cardStyle += 'border-radius:' + (d.borderRadius ?? 12) + 'px;';
        if (d.shadow && d.shadow !== 'none') cardStyle += 'box-shadow:' + getShadowValue(d.shadow, d.glowColor) + ';';
        const animClass = (d.animation && d.animation !== 'none') ? ' anim-' + d.animation : '';

        cardsHTML += '    <div class="card' + animClass + '" style="' + cardStyle + '">\n';
        if (d.image) {
          cardsHTML += '      <div class="card-img"><img src="' + escHTML(d.image.exportPath) + '" alt="' + escHTML(d.image.filename) + '" /></div>\n';
        }
        if (d.text.trim()) {
          const ts = 'font-family:' + d.fontFamily + ';font-size:' + d.fontSize + 'px;font-weight:' + d.fontWeight + ';color:' + d.fontColor + ';';
          const mdCls = d.inputMode === 'md' ? ' md-rendered' : '';
          const content = d.inputMode === 'md' ? '<div class="md-inner">' + parseMDWithSize(d.text) + '</div>' : escHTML(d.text).replace(/\n/g,'<br>');
          cardsHTML += '      <div class="card-text' + mdCls + '" style="' + ts + '">' + content + '</div>\n';
        }
        cardsHTML += '    </div>\n';
      }

      const pageBg = escHTML(settings.pageBgColor || '#f5f5f5');
      const cssLink = settings.exportCssPath ? '  <link rel="stylesheet" href="' + escHTML(settings.exportCssPath) + '" />\n' : '';

      const html = '<!DOCTYPE html>\n<html lang="ja">\n<head>\n'
        + '  <meta charset="UTF-8" />\n'
        + '  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n'
        + '  <title>' + escHTML(title) + '</title>\n'
        + '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">\n'
        + cssLink
        + '  <style>\n'
        + '    *{ box-sizing:border-box; margin:0; padding:0; }\n'
        + '    body{ font-family:"Noto Sans JP",sans-serif; background:' + pageBg + '; }' + bgCSS + '\n'
        + '    .container{ position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:20px; }\n'
        + '    .card-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; }\n'
        + '    .card{ aspect-ratio:1/1; overflow:hidden; display:flex; flex-direction:column; }\n'
        + '    .card-img{ flex:0 0 60%; overflow:hidden; }\n'
        + '    .card-img img{ width:100%; height:100%; object-fit:cover; display:block; }\n'
        + '    .card-text{ flex:1; padding:12px; line-height:1.5; word-break:break-word; overflow:hidden; }\n'
        + '    .md-rendered{ white-space:normal; } .md-rendered .md-inner{ width:100%; }\n'
        + '    .md-rendered h1{ font-size:1.4em; font-weight:700; margin:0.2em 0; }\n'
        + '    .md-rendered h2{ font-size:1.2em; font-weight:700; margin:0.2em 0; }\n'
        + '    .md-rendered h3{ font-size:1.1em; font-weight:700; margin:0.15em 0; }\n'
        + '    .md-rendered p{ margin:0.2em 0; } .md-rendered strong{ font-weight:700; } .md-rendered em{ font-style:italic; }\n'
        + '    .md-rendered code{ background:rgba(128,128,128,0.2); padding:1px 5px; border-radius:3px; font-family:monospace; font-size:0.9em; }\n'
        + '    .size-marker{ font-size:inherit; }\n'
        + '    .md-rendered ul,.md-rendered ol{ padding-left:1.5em; margin:0.2em 0; } .md-rendered li{ margin:0.1em 0; }\n'
        + '    .md-rendered blockquote{ border-left:3px solid #e94560; padding-left:10px; margin:0.3em 0; opacity:0.85; }\n'
        + '    .md-rendered a{ color:#5ba8ff; text-decoration:underline; }\n'
        + '    @keyframes fadeIn{from{opacity:0}to{opacity:1}}\n'
        + '    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}\n'
        + '    @keyframes slideLeft{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}\n'
        + '    @keyframes slideRight{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}\n'
        + '    @keyframes zoomIn{from{opacity:0;transform:scale(0.85)}to{opacity:1;transform:scale(1)}}\n'
        + '    @keyframes bounce{0%{opacity:0;transform:translateY(30px)}60%{opacity:1;transform:translateY(-8px)}80%{transform:translateY(3px)}100%{transform:translateY(0)}}\n'
        + '    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}\n'
        + '    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}\n'
        + '    .anim-fadeIn{animation:fadeIn .6s ease both} .anim-slideUp{animation:slideUp .6s ease both}\n'
        + '    .anim-slideLeft{animation:slideLeft .6s ease both} .anim-slideRight{animation:slideRight .6s ease both}\n'
        + '    .anim-zoomIn{animation:zoomIn .5s ease both} .anim-bounce{animation:bounce .7s ease both}\n'
        + '    .anim-pulse{animation:pulse 2s ease-in-out infinite} .anim-float{animation:float 3s ease-in-out infinite}\n'
        + '    .anim-clickFade{cursor:pointer;transition:opacity .4s ease,transform .4s ease}\n'
        + '    .anim-clickFade.faded{opacity:0;transform:scale(0.95);pointer-events:none}\n'
        + '  </style>\n</head>\n<body>\n'
        + (bgExportPath ? '  <div class="bg-layer"></div>\n' : '')
        + '  <div class="container">\n    <div class="card-grid">\n'
        + cardsHTML
        + '    </div>\n  </div>\n'
        + '  <script>document.querySelectorAll(".anim-clickFade").forEach(el=>{el.addEventListener("click",()=>el.classList.toggle("faded"))});<\/script>\n'
        + '</body>\n</html>';

      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (settings.exportTitle || 'blog-cards').replace(/\s+/g, '-') + '.html';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportGridHTML() {
      const bgExportPath = settings.bgPath || '';
      const title = settings.exportTitle || 'ãƒ–ãƒ­ã‚°è¨˜äº‹';
      let bgCSS = '';
      if (bgExportPath) {
        bgCSS = `
    .bg-layer {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-image: url(${bgExportPath});
      background-size: cover; background-position: center; background-attachment: fixed;
      z-index: 0;
    }`;
      }

      let cellsHTML = '';
      for (let r = 0; r < ROWS; r++) {
        let rowHasContent = false;
        for (let c = 0; c < COLS; c++) {
          const d = cellData[r * COLS + c];
          if (d.image || d.text.trim()) { rowHasContent = true; break; }
        }
        if (!rowHasContent) continue;

        cellsHTML += `    <div class="grid-row" style="--w:2; --h:1;">\n`;
        for (let c = 0; c < COLS; c++) {
          const d = cellData[r * COLS + c];

          if (!d.image && !d.text.trim()) continue;

          if (d.image) {
            let itemStyle = `grid-column: ${c*4+1} / span 4;`;
            if (d.bgColor) itemStyle += `background:${hexToRgba(d.bgColor, d.bgOpacity ?? 100)};`;
            itemStyle += `border-radius:${d.borderRadius ?? 10}px;`;
            if (d.shadow && d.shadow !== 'none') itemStyle += `box-shadow:${getShadowValue(d.shadow, d.glowColor)};`;
            const animClass = (d.animation && d.animation !== 'none') ? ' anim-' + d.animation : '';
            cellsHTML += `      <div class="grid-item${animClass}" style="${itemStyle}">\n`;
            cellsHTML += `        <img src="${escHTML(d.image.exportPath)}" alt="${escHTML(d.image.filename)}" />\n`;
            cellsHTML += `      </div>\n`;
            continue;
          }

          const wm = d.writingMode === 'v' ? 'writing-mode:vertical-rl;' : '';
          let ha, va;
          if (d.writingMode === 'v') {
            ha = d.hAlign === 'center' ? 'align-items:center;' : d.hAlign === 'right' ? 'align-items:flex-start;' : 'align-items:flex-end;';
            va = d.vAlign === 'top' ? 'justify-content:flex-start;' : d.vAlign === 'bottom' ? 'justify-content:flex-end;' : 'justify-content:center;';
          } else {
            ha = d.hAlign === 'center' ? 'text-align:center;justify-content:center;' : d.hAlign === 'right' ? 'text-align:right;justify-content:flex-end;' : 'text-align:left;justify-content:flex-start;';
            va = d.vAlign === 'top' ? 'align-items:flex-start;' : d.vAlign === 'bottom' ? 'align-items:flex-end;' : 'align-items:center;';
          }
          const style = `font-family:${d.fontFamily};font-size:${d.fontSize}px;font-weight:${d.fontWeight};color:${d.fontColor};${wm}${ha}${va}`;
          let itemStyle = `grid-column: ${c*4+1} / span 4;`;
          if (d.bgColor) itemStyle += `background:${hexToRgba(d.bgColor, d.bgOpacity ?? 100)};`;
          itemStyle += `border-radius:${d.borderRadius ?? 10}px;`;
          if (d.shadow && d.shadow !== 'none') itemStyle += `box-shadow:${getShadowValue(d.shadow, d.glowColor)};`;
          const animClass = (d.animation && d.animation !== 'none') ? ' anim-' + d.animation : '';
          let text;
          if (d.inputMode === 'md' && d.text.trim()) {
            text = `<div class="md-inner">${parseMDWithSize(d.text)}</div>`;
          } else {
            text = escHTML(d.text).replace(/\n/g,'<br>');
          }
          const mdClass = d.inputMode === 'md' && d.text.trim() ? ' md-rendered' : '';
          cellsHTML += `      <div class="grid-item${animClass}" style="${itemStyle}">\n`;
          cellsHTML += `        <div class="grid-item-inner${mdClass}" style="${style}">\n`;
          cellsHTML += `          ${text}\n`;
          cellsHTML += `        </div>\n`;
          cellsHTML += `      </div>\n`;
        }
        cellsHTML += `    </div>\n`;
      }

      const html = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${escHTML(title)}</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
  ${settings.exportCssPath ? `<link rel="stylesheet" href="${escHTML(settings.exportCssPath)}" />` : ''}
  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{ font-family: 'Noto Sans JP', sans-serif; background:${escHTML(settings.pageBgColor || '#f5f5f5')}; }${bgCSS}
    .container{ position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:20px; }
    .grid-row{ display:grid; grid-template-columns:repeat(12,1fr); gap:15px; margin-bottom:15px; aspect-ratio:var(--w)/var(--h); }
    .grid-item{ background:transparent; border-radius:10px; overflow:hidden; }
    .grid-item > img{ width:100%; height:100%; object-fit:cover; display:block; }
    .grid-item-inner{ width:100%; height:100%; display:flex; padding:12px; line-height:1.6; white-space:pre-wrap; word-break:break-word; }
    .md-rendered { white-space:normal; }
    .md-rendered .md-inner { width:100%; }
    .size-marker { font-size:inherit; }
    .md-rendered h1 { font-size:1.6em; font-weight:700; margin:0.3em 0; }
    .md-rendered h2 { font-size:1.35em; font-weight:700; margin:0.3em 0; }
    .md-rendered h3 { font-size:1.15em; font-weight:700; margin:0.25em 0; }
    .md-rendered h4 { font-size:1em; font-weight:700; margin:0.2em 0; }
    .md-rendered p { margin:0.3em 0; }
    .md-rendered strong { font-weight:700; }
    .md-rendered em { font-style:italic; }
    .md-rendered code { background:rgba(128,128,128,0.2); padding:1px 5px; border-radius:3px; font-family:monospace; font-size:0.9em; }
    .md-rendered pre { background:rgba(0,0,0,0.1); padding:8px 10px; border-radius:6px; overflow-x:auto; margin:0.4em 0; white-space:pre-wrap; }
    .md-rendered pre code { background:none; padding:0; }
    .md-rendered ul,.md-rendered ol { padding-left:1.5em; margin:0.3em 0; }
    .md-rendered li { margin:0.15em 0; }
    .md-rendered blockquote { border-left:3px solid #e94560; padding-left:10px; margin:0.4em 0; opacity:0.85; }
    .md-rendered hr { border:none; border-top:1px solid rgba(128,128,128,0.4); margin:0.5em 0; }
    .md-rendered a { color:#5ba8ff; text-decoration:underline; }
    .md-rendered img { max-width:100%; border-radius:4px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes zoomIn { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }
    @keyframes bounce { 0% { opacity:0; transform:translateY(30px); } 60% { opacity:1; transform:translateY(-8px); } 80% { transform:translateY(3px); } 100% { transform:translateY(0); } }
    @keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.03); } }
    @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-8px); } }
    .anim-fadeIn { animation:fadeIn 0.6s ease both; }
    .anim-slideUp { animation:slideUp 0.6s ease both; }
    .anim-slideLeft { animation:slideLeft 0.6s ease both; }
    .anim-slideRight { animation:slideRight 0.6s ease both; }
    .anim-zoomIn { animation:zoomIn 0.5s ease both; }
    .anim-bounce { animation:bounce 0.7s ease both; }
    .anim-pulse { animation:pulse 2s ease-in-out infinite; }
    .anim-float { animation:float 3s ease-in-out infinite; }
    .anim-clickFade { cursor:pointer; transition:opacity 0.4s ease, transform 0.4s ease; }
    .anim-clickFade.faded { opacity:0; transform:scale(0.95); pointer-events:none; }
    @media (max-width:768px){ .grid-row{ grid-template-columns:1fr !important; aspect-ratio:auto; } .grid-item{ grid-column:1 / -1 !important; aspect-ratio:auto; } .grid-item-inner{ height:auto; min-height:40px; } }
  </style>
</head>
<body>
  ${bgExportPath ? '<div class="bg-layer"></div>' : ''}
  <div class="container">
${cellsHTML}  </div>
  <script>
    document.querySelectorAll('.anim-clickFade').forEach(el => {
      el.addEventListener('click', () => el.classList.toggle('faded'));
    });
  <\/script>
</body>
</html>`;

      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (settings.exportTitle || 'blog-post').replace(/\s+/g, '-') + '.html';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function escHTML(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ===== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
    function previewAnimation() {
      if (selectedIdx < 0) return;
      const d = cellData[selectedIdx];
      if (!d.animation || d.animation === 'none') return;
      const cellSelector = settings.layoutMode === 'card' ? '.card-cell' : '.grid-cell';
      const cell = document.querySelector(`${cellSelector}[data-idx="${selectedIdx}"]`);
      if (!cell) return;
      if (d.animation === 'clickFade') {
        cell.classList.add('faded');
        setTimeout(() => cell.classList.remove('faded'), 1200);
        return;
      }
      const cls = 'anim-' + d.animation;
      cell.classList.remove(cls);
      void cell.offsetWidth;
      cell.classList.add(cls);
    }

    function switchLayoutMode(mode) {
      settings.layoutMode = mode;
      document.querySelectorAll('#layoutModeToggle .toggle-btn').forEach(b =>
        b.classList.toggle('active', b.dataset.val === mode)
      );
      document.getElementById('cardSettings').style.display = mode === 'card' ? '' : 'none';
      saveSettings();
      buildGrid();
      renderAll();
    }

    function updateCardCount() {
      const val = parseInt(document.getElementById('cardCount').value) || 12;
      settings.cardCount = Math.max(2, Math.min(48, val));
      document.getElementById('cardCount').value = settings.cardCount;
      saveSettings();
      buildGrid();
      renderAll();
    }

    // ===== åˆæœŸåŒ– =====
    function init() {
      document.getElementById('bgPath').value = settings.bgPath || '';
      const initBgColor = settings.pageBgColor || '#f5f5f5';
      document.getElementById('pageBgColor').value = initBgColor;
      applyPageBgColor(initBgColor);
      document.getElementById('exportTitle').value = settings.exportTitle || '';
      document.getElementById('exportCssPath').value = settings.exportCssPath || '';
      const mode = settings.layoutMode || 'grid';
      document.querySelectorAll('#layoutModeToggle .toggle-btn').forEach(b =>
        b.classList.toggle('active', b.dataset.val === mode)
      );
      document.getElementById('cardSettings').style.display = mode === 'card' ? '' : 'none';
      document.getElementById('cardCount').value = settings.cardCount || 12;
      renderPathList();
      updateCurrentPathDisplay();

      buildGrid();
      renderAll();

      initToggleGroup('writingMode', 'writingMode');
      initToggleGroup('hAlign', 'hAlign');
      initToggleGroup('vAlign', 'vAlign');

      const imBtns = document.querySelectorAll('#inputMode .toggle-btn');
      imBtns.forEach(b => {
        b.onclick = () => {
          imBtns.forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          if (selectedIdx >= 0) {
            cellData[selectedIdx].inputMode = b.dataset.val;
            renderCell(selectedIdx);
            const isMarkdown = b.dataset.val === 'md';
            document.getElementById('textSizeTools').style.display = isMarkdown ? '' : 'none';
            document.getElementById('mdHelp').style.display = isMarkdown ? '' : 'none';
            document.getElementById('cellText').placeholder = isMarkdown
              ? '# è¦‹å‡ºã—\n**å¤ªå­—** *æ–œä½“*\n- ãƒªã‚¹ãƒˆé …ç›®\n{ãƒ†ã‚­ã‚¹ãƒˆ|1.5} ã§å¤§ãã' : 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦';
          }
        };
      });

      bindInput('cellText', 'text');
      bindInput('fontFamily', 'fontFamily');
      bindInput('fontSize', 'fontSize', v => parseInt(v) || 16);
      bindInput('fontWeight', 'fontWeight');
      bindInput('fontColor', 'fontColor');

      document.getElementById('cellBgColor').addEventListener('input', (e) => {
        if (selectedIdx < 0) return;
        cellData[selectedIdx].bgColor = e.target.value;
        renderCell(selectedIdx);
      });
      document.getElementById('cellBgOpacity').addEventListener('input', (e) => {
        if (selectedIdx < 0) return;
        cellData[selectedIdx].bgOpacity = parseInt(e.target.value);
        document.getElementById('bgOpacityVal').textContent = e.target.value;
        renderCell(selectedIdx);
      });
      document.getElementById('cellBorderRadius').addEventListener('input', (e) => {
        if (selectedIdx < 0) return;
        cellData[selectedIdx].borderRadius = parseInt(e.target.value);
        document.getElementById('borderRadiusVal').textContent = e.target.value;
        renderCell(selectedIdx);
      });
      bindInput('cellShadow', 'shadow');
      document.getElementById('cellShadow').addEventListener('change', () => {
        const isGlow = document.getElementById('cellShadow').value === 'glow';
        document.getElementById('glowColorRow').style.display = isGlow ? '' : 'none';
      });
      document.getElementById('cellGlowColor').addEventListener('input', (e) => {
        if (selectedIdx < 0) return;
        cellData[selectedIdx].glowColor = e.target.value;
        renderCell(selectedIdx);
      });
      bindInput('cellAnimation', 'animation');

      document.getElementById('previewArea').addEventListener('click', (e) => {
        if (!e.target.closest('.grid-cell') && !e.target.closest('.card-cell')) deselectCell();
      });
    }

    init();
  </script>
</body>
</html>
