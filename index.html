<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-panel: #1e2a45;
      --accent: #e94560;
      --accent-dim: #c73a52;
      --text: #eaeaea;
      --text-dim: #8899aa;
      --border: #2a3a55;
      --cell-hover: rgba(233,69,96,0.12);
      --cell-selected: rgba(233,69,96,0.22);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .app-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .app-title .icon { color: var(--accent); font-size: 22px; }
    .header-actions { display: flex; gap: 8px; }

    /* ===== ãƒœã‚¿ãƒ³å…±é€š ===== */
    .btn {
      padding: 7px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-panel);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn:hover { border-color: var(--accent); background: rgba(233,69,96,0.1); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 500; }
    .btn-primary:hover { background: var(--accent-dim); }
    .btn-sm { padding: 4px 10px; font-size: 12px; }

    /* ===== ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    .app-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ===== ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« ===== */
    .side-panel {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    .panel-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .panel-section:last-child { border-bottom: none; }
    .panel-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    /* ===== ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ ===== */
    .form-row { margin-bottom: 10px; }
    .form-row:last-child { margin-bottom: 0; }
    .form-row label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    textarea.cell-text-input {
      width: 100%;
      min-height: 80px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      line-height: 1.6;
    }
    textarea.cell-text-input:focus { outline: none; border-color: var(--accent); }
    select, input[type="number"], input[type="color"], input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
    }
    select:focus, input:focus { outline: none; border-color: var(--accent); }
    input[type="color"] { height: 34px; padding: 2px 4px; cursor: pointer; }

    /* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .toggle-group {
      display: flex;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .toggle-btn {
      flex: 1;
      padding: 6px 0;
      border: none;
      background: var(--bg-primary);
      color: var(--text-dim);
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .toggle-btn + .toggle-btn { border-left: 1px solid var(--border); }
    .toggle-btn.active { background: var(--accent); color: #fff; }
    .toggle-btn:hover:not(.active) { background: rgba(233,69,96,0.1); color: var(--text); }

    /* ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ ===== */
    .preview-area {
      flex: 1;
      overflow: auto;
      padding: 24px;
      display: flex;
      justify-content: center;
      background: #111;
    }
    .preview-wrapper {
      position: relative;
      width: 100%;
      max-width: 1200px;
    }
    .grid-container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ===== ã‚°ãƒªãƒƒãƒ‰è¡Œ ===== */
    .grid-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
      aspect-ratio: 3 / 1;
    }
    .grid-cell {
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: outline 0.15s;
      outline: 2px solid transparent;
      display: flex;
    }
    .grid-cell:hover { outline-color: rgba(233,69,96,0.4); }
    .grid-cell.selected { outline-color: var(--accent); }
    .grid-cell:nth-child(1),
    .grid-cell:nth-child(3) { background: transparent; }
    .grid-cell:nth-child(2) { background: rgba(255,255,255,0.5); }

    .cell-content {
      width: 100%;
      height: 100%;
      padding: 12px;
      display: flex;
      overflow: hidden;
      word-break: break-word;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .cell-content.h-write { writing-mode: horizontal-tb; }
    .cell-content.v-write { writing-mode: vertical-rl; }
    .cell-content.align-left   { justify-content: flex-start; text-align: left; }
    .cell-content.align-center { justify-content: center; text-align: center; }
    .cell-content.align-right  { justify-content: flex-end; text-align: right; }
    .cell-content.v-write.align-left   { align-items: flex-end; }
    .cell-content.v-write.align-center { align-items: center; }
    .cell-content.v-write.align-right  { align-items: flex-start; }
    .cell-content.valign-top    { align-items: flex-start; }
    .cell-content.valign-middle { align-items: center; }
    .cell-content.valign-bottom { align-items: flex-end; }
    .cell-content.v-write.valign-top    { justify-content: flex-start; }
    .cell-content.v-write.valign-middle { justify-content: center; }
    .cell-content.v-write.valign-bottom { justify-content: flex-end; }

    /* ã‚»ãƒ«ç•ªå·ãƒãƒƒã‚¸ */
    .cell-badge {
      position: absolute;
      top: 4px; left: 4px;
      font-size: 9px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 1px 5px;
      border-radius: 3px;
      pointer-events: none;
      opacity: 0.6;
    }

    /* ===== ãƒ•ã‚©ãƒ³ãƒˆé¸æŠ ===== */
    .font-option-serif { font-family: 'Noto Serif JP', serif; }
    .font-option-sans  { font-family: 'Noto Sans JP', sans-serif; }

    /* ===== ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æç”» ===== */
    .cell-content.md-rendered h1 { font-size: 1.6em; font-weight: 700; margin: 0.3em 0; line-height: 1.3; }
    .cell-content.md-rendered h2 { font-size: 1.35em; font-weight: 700; margin: 0.3em 0; line-height: 1.3; }
    .cell-content.md-rendered h3 { font-size: 1.15em; font-weight: 700; margin: 0.25em 0; line-height: 1.3; }
    .cell-content.md-rendered h4 { font-size: 1em; font-weight: 700; margin: 0.2em 0; }
    .cell-content.md-rendered p { margin: 0.3em 0; }
    .cell-content.md-rendered strong { font-weight: 700; }
    .cell-content.md-rendered em { font-style: italic; }
    .cell-content.md-rendered code {
      background: rgba(128,128,128,0.2);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    .cell-content.md-rendered pre {
      background: rgba(0,0,0,0.25);
      padding: 8px 10px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 0.4em 0;
      white-space: pre-wrap;
    }
    .cell-content.md-rendered pre code {
      background: none;
      padding: 0;
      border-radius: 0;
    }
    .cell-content.md-rendered ul, .cell-content.md-rendered ol {
      padding-left: 1.5em;
      margin: 0.3em 0;
    }
    .cell-content.md-rendered li { margin: 0.15em 0; }
    .cell-content.md-rendered blockquote {
      border-left: 3px solid var(--accent, #e94560);
      padding-left: 10px;
      margin: 0.4em 0;
      opacity: 0.85;
    }
    .cell-content.md-rendered hr {
      border: none;
      border-top: 1px solid rgba(128,128,128,0.4);
      margin: 0.5em 0;
    }
    .cell-content.md-rendered a {
      color: #5ba8ff;
      text-decoration: underline;
    }
    .cell-content.md-rendered img {
      max-width: 100%;
      border-radius: 4px;
    }
    .cell-content.md-rendered {
      white-space: normal;
    }
    .cell-content.md-rendered .md-inner {
      width: 100%;
    }

    /* MDãƒ¢ãƒ¼ãƒ‰ãƒãƒƒã‚¸ */
    .md-badge {
      position: absolute;
      top: 4px; right: 4px;
      font-size: 8px;
      background: rgba(91,168,255,0.5);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
      pointer-events: none;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* ===== ç©ºçŠ¶æ…‹ ===== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
      color: var(--text-dim);
    }
    .empty-state .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state p { font-size: 13px; line-height: 1.6; }

    /* ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨éè¡¨ç¤º ===== */
    .export-mode .cell-badge,
    .export-mode .grid-cell { outline: none !important; cursor: default; }

    /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
    @media (max-width: 900px) {
      .app-body { flex-direction: column; }
      .side-panel { width: 100%; max-height: 300px; border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="app-header">
    <div class="app-title">
      <span class="icon">âŠ</span> ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿
    </div>
    <div class="header-actions">
      <button class="btn" onclick="exportHTML()">ğŸ“„ HTMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </header>

  <div class="app-body">
    <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <aside class="side-panel" id="sidePanel">
      <!-- èƒŒæ™¯ç”»åƒ -->
      <div class="panel-section">
        <div class="panel-label">ğŸ–¼ èƒŒæ™¯ç”»åƒï¼ˆå›ºå®šï¼‰</div>
        <div class="form-row">
          <label>ç”»åƒãƒ‘ã‚¹ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰</label>
          <input type="text" id="bgExportPath" placeholder="ä¾‹: images/bg.jpg  /img/bg.png  https://â€¦" />
        </div>
        <div style="font-size:10px; color:var(--text-dim); margin-top:4px; line-height:1.4;">
          â€» ç›¸å¯¾ãƒ‘ã‚¹ãƒ»çµ¶å¯¾ãƒ‘ã‚¹ãƒ»URLã‚’æŒ‡å®šã§ãã¾ã™ã€‚<br>æœªå…¥åŠ›ã®å ´åˆã€èƒŒæ™¯ãªã—ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

      <!-- ã‚»ãƒ«ç·¨é›†ãƒ‘ãƒãƒ«ï¼ˆã‚»ãƒ«é¸æŠæ™‚ã«è¡¨ç¤ºï¼‰ -->
      <div id="cellEditor" style="display:none;">
        <div class="panel-section">
          <div class="panel-label" id="cellEditorTitle">ğŸ“ ã‚»ãƒ«ç·¨é›†</div>
          <div class="form-row">
            <label>ãƒ†ã‚­ã‚¹ãƒˆ</label>
            <textarea class="cell-text-input" id="cellText" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦"></textarea>
          </div>
          <div class="form-row">
            <label>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
            <div class="toggle-group" id="inputMode">
              <button class="toggle-btn active" data-val="plain">ãƒ—ãƒ¬ãƒ¼ãƒ³</button>
              <button class="toggle-btn" data-val="md">ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³</button>
            </div>
          </div>
          <div id="mdHelp" style="display:none; margin-top:6px; font-size:11px; color:var(--text-dim); line-height:1.5; padding:6px 8px; background:var(--bg-primary); border-radius:5px;">
            <b># è¦‹å‡ºã—</b>ã€€<b>**å¤ªå­—**</b>ã€€<b>*æ–œä½“*</b><br>
            <b>- ãƒªã‚¹ãƒˆ</b>ã€€<b>1. ç•ªå·ãƒªã‚¹ãƒˆ</b><br>
            <b>`ã‚³ãƒ¼ãƒ‰`</b>ã€€<b>> å¼•ç”¨</b>ã€€<b>---</b><br>
            <b>[ãƒªãƒ³ã‚¯](URL)</b>ã€€<b>![ç”»åƒ](URL)</b>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-label">æ–‡å­—æ–¹å‘</div>
          <div class="form-row">
            <div class="toggle-group" id="writingMode">
              <button class="toggle-btn active" data-val="h">æ¨ªæ›¸ã</button>
              <button class="toggle-btn" data-val="v">ç¸¦æ›¸ã</button>
            </div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-label">é…ç½®</div>
          <div class="form-row">
            <label>æ¨ªæƒãˆ</label>
            <div class="toggle-group" id="hAlign">
              <button class="toggle-btn active" data-val="left">å·¦</button>
              <button class="toggle-btn" data-val="center">ä¸­å¤®</button>
              <button class="toggle-btn" data-val="right">å³</button>
            </div>
          </div>
          <div class="form-row" style="margin-top:8px;">
            <label>ç¸¦æƒãˆ</label>
            <div class="toggle-group" id="vAlign">
              <button class="toggle-btn" data-val="top">ä¸Š</button>
              <button class="toggle-btn active" data-val="middle">ä¸­å¤®</button>
              <button class="toggle-btn" data-val="bottom">ä¸‹</button>
            </div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-label">ãƒ•ã‚©ãƒ³ãƒˆ</div>
          <div class="form-row">
            <label>æ›¸ä½“</label>
            <select id="fontFamily">
              <option value="'Noto Sans JP', sans-serif">ã‚´ã‚·ãƒƒã‚¯ä½“</option>
              <option value="'Noto Serif JP', serif">æ˜æœä½“</option>
            </select>
          </div>
          <div class="form-row">
            <label>ã‚µã‚¤ã‚º (px)</label>
            <input type="number" id="fontSize" value="16" min="8" max="120" step="1" />
          </div>
          <div class="form-row">
            <label>å¤ªã•</label>
            <select id="fontWeight">
              <option value="300">Light</option>
              <option value="400" selected>Regular</option>
              <option value="500">Medium</option>
              <option value="700">Bold</option>
            </select>
          </div>
          <div class="form-row">
            <label>æ–‡å­—è‰²</label>
            <input type="color" id="fontColor" value="#333333" />
          </div>
        </div>
      </div>

      <!-- æœªé¸æŠæ™‚ -->
      <div id="emptyEditor" class="panel-section">
        <div class="empty-state">
          <div class="icon">ğŸ‘†</div>
          <p>ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦<br>ç·¨é›†ã‚’é–‹å§‹ã—ã¾ã™</p>
        </div>
      </div>
    </aside>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <main class="preview-area" id="previewArea">
      <div class="preview-wrapper">
        <div class="grid-container" id="gridContainer"></div>
      </div>
    </main>
  </div>

  <script>
    // ===== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« =====
    const ROWS = 36;
    const COLS = 3;
    const cellData = [];
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        cellData.push({
          row: r, col: c,
          text: '',
          inputMode: 'plain', // plain | md
          writingMode: 'h', // h | v
          hAlign: 'left',
          vAlign: 'middle',
          fontFamily: "'Noto Sans JP', sans-serif",
          fontSize: 16,
          fontWeight: '400',
          fontColor: '#333333',
        });
      }
    }

    let selectedIdx = -1;

    // ===== ã‚°ãƒªãƒƒãƒ‰æ§‹ç¯‰ =====
    function buildGrid() {
      const container = document.getElementById('gridContainer');
      container.innerHTML = '';
      for (let r = 0; r < ROWS; r++) {
        const row = document.createElement('div');
        row.className = 'grid-row';
        for (let c = 0; c < COLS; c++) {
          const idx = r * COLS + c;
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          cell.dataset.idx = idx;
          cell.onclick = () => selectCell(idx);

          const badge = document.createElement('div');
          badge.className = 'cell-badge';
          badge.textContent = `${r+1}-${c+1}`;

          const mdBadge = document.createElement('div');
          mdBadge.className = 'md-badge';
          mdBadge.id = `md-badge-${idx}`;
          mdBadge.textContent = 'MD';
          mdBadge.style.display = 'none';

          const content = document.createElement('div');
          content.className = 'cell-content';
          content.id = `content-${idx}`;

          cell.appendChild(badge);
          cell.appendChild(mdBadge);
          cell.appendChild(content);
          row.appendChild(cell);
        }
        container.appendChild(row);
      }
    }

    // ===== ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ =====
    function parseMD(src) {
      // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—HTML
      const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      let html = '';
      const lines = src.split('\n');
      let i = 0;
      let inUl = false, inOl = false;

      function closeList() {
        if (inUl) { html += '</ul>'; inUl = false; }
        if (inOl) { html += '</ol>'; inOl = false; }
      }

      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¤‰æ›
      function inlineMarkup(text) {
        text = esc(text);
        // ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‘ãƒ³
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        // ç”»åƒ
        text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" />');
        // ãƒªãƒ³ã‚¯
        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        // å¤ªå­—+æ–œä½“
        text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
        // å¤ªå­—
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // æ–œä½“
        text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // æ‰“ã¡æ¶ˆã—ç·š
        text = text.replace(/~~(.+?)~~/g, '<del>$1</del>');
        return text;
      }

      while (i < lines.length) {
        const line = lines[i];

        // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
        if (line.trimStart().startsWith('```')) {
          closeList();
          let code = '';
          i++;
          while (i < lines.length && !lines[i].trimStart().startsWith('```')) {
            code += (code ? '\n' : '') + esc(lines[i]);
            i++;
          }
          html += `<pre><code>${code}</code></pre>`;
          i++;
          continue;
        }

        // è¦‹å‡ºã—
        const headingMatch = line.match(/^(#{1,4})\s+(.+)/);
        if (headingMatch) {
          closeList();
          const level = headingMatch[1].length;
          html += `<h${level}>${inlineMarkup(headingMatch[2])}</h${level}>`;
          i++; continue;
        }

        // æ°´å¹³ç·š
        if (/^(---|\*\*\*|___)\s*$/.test(line.trim())) {
          closeList();
          html += '<hr>';
          i++; continue;
        }

        // å¼•ç”¨
        if (line.trimStart().startsWith('> ')) {
          closeList();
          let bq = '';
          while (i < lines.length && lines[i].trimStart().startsWith('> ')) {
            bq += (bq ? '<br>' : '') + inlineMarkup(lines[i].replace(/^>\s?/, ''));
            i++;
          }
          html += `<blockquote>${bq}</blockquote>`;
          continue;
        }

        // ç•ªå·ãªã—ãƒªã‚¹ãƒˆ
        const ulMatch = line.match(/^[\s]*([-*+])\s+(.+)/);
        if (ulMatch) {
          if (inOl) { html += '</ol>'; inOl = false; }
          if (!inUl) { html += '<ul>'; inUl = true; }
          html += `<li>${inlineMarkup(ulMatch[2])}</li>`;
          i++; continue;
        }

        // ç•ªå·ä»˜ããƒªã‚¹ãƒˆ
        const olMatch = line.match(/^[\s]*(\d+)[.)]\s+(.+)/);
        if (olMatch) {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (!inOl) { html += '<ol>'; inOl = true; }
          html += `<li>${inlineMarkup(olMatch[2])}</li>`;
          i++; continue;
        }

        // ç©ºè¡Œ
        if (line.trim() === '') {
          closeList();
          i++; continue;
        }

        // é€šå¸¸æ®µè½
        closeList();
        html += `<p>${inlineMarkup(line)}</p>`;
        i++;
      }
      closeList();
      return html;
    }

    // ===== ã‚»ãƒ«æç”» =====
    function renderCell(idx) {
      const d = cellData[idx];
      const el = document.getElementById(`content-${idx}`);
      const mdBadge = document.getElementById(`md-badge-${idx}`);
      if (!el) return;

      el.className = 'cell-content';
      el.classList.add(d.writingMode === 'v' ? 'v-write' : 'h-write');
      el.classList.add(`align-${d.hAlign}`);
      el.classList.add(`valign-${d.vAlign}`);
      el.style.fontFamily = d.fontFamily;
      el.style.fontSize = d.fontSize + 'px';
      el.style.fontWeight = d.fontWeight;
      el.style.color = d.fontColor;

      if (d.inputMode === 'md' && d.text.trim()) {
        el.classList.add('md-rendered');
        el.innerHTML = `<div class="md-inner">${parseMD(d.text)}</div>`;
        if (mdBadge) mdBadge.style.display = '';
      } else {
        el.textContent = d.text;
        if (mdBadge) mdBadge.style.display = 'none';
      }
    }

    function renderAll() {
      cellData.forEach((_, i) => renderCell(i));
    }

    // ===== ã‚»ãƒ«é¸æŠ =====
    function selectCell(idx) {
      // å‰ã®é¸æŠã‚’å¤–ã™
      document.querySelectorAll('.grid-cell.selected').forEach(el => el.classList.remove('selected'));

      selectedIdx = idx;
      const cell = document.querySelector(`.grid-cell[data-idx="${idx}"]`);
      if (cell) cell.classList.add('selected');

      const d = cellData[idx];
      document.getElementById('cellEditor').style.display = '';
      document.getElementById('emptyEditor').style.display = 'none';
      document.getElementById('cellEditorTitle').textContent = `ğŸ“ ã‚»ãƒ« ${d.row+1}-${d.col+1}`;

      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’åæ˜ 
      document.getElementById('cellText').value = d.text;
      setToggle('inputMode', d.inputMode);
      setToggle('writingMode', d.writingMode);
      setToggle('hAlign', d.hAlign);
      setToggle('vAlign', d.vAlign);
      document.getElementById('fontFamily').value = d.fontFamily;
      document.getElementById('fontSize').value = d.fontSize;
      document.getElementById('fontWeight').value = d.fontWeight;
      document.getElementById('fontColor').value = d.fontColor;

      // MDãƒ˜ãƒ«ãƒ—ã®è¡¨ç¤ºåˆ‡æ›¿
      document.getElementById('mdHelp').style.display = d.inputMode === 'md' ? '' : 'none';
      // MDãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
      document.getElementById('cellText').placeholder = d.inputMode === 'md' 
        ? '# è¦‹å‡ºã—\n**å¤ªå­—** *æ–œä½“*\n- ãƒªã‚¹ãƒˆé …ç›®' 
        : 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦';

      document.getElementById('cellText').focus();
    }

    function deselectCell() {
      document.querySelectorAll('.grid-cell.selected').forEach(el => el.classList.remove('selected'));
      selectedIdx = -1;
      document.getElementById('cellEditor').style.display = 'none';
      document.getElementById('emptyEditor').style.display = '';
    }

    // ===== ãƒˆã‚°ãƒ«ã‚°ãƒ«ãƒ¼ãƒ— =====
    function setToggle(groupId, val) {
      const btns = document.querySelectorAll(`#${groupId} .toggle-btn`);
      btns.forEach(b => b.classList.toggle('active', b.dataset.val === val));
    }

    function initToggleGroup(groupId, field) {
      const btns = document.querySelectorAll(`#${groupId} .toggle-btn`);
      btns.forEach(b => {
        b.onclick = () => {
          btns.forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          if (selectedIdx >= 0) {
            cellData[selectedIdx][field] = b.dataset.val;
            renderCell(selectedIdx);
          }
        };
      });
    }

    // ===== å…¥åŠ›ãƒã‚¤ãƒ³ãƒ‰ =====
    function bindInput(elId, field, transform) {
      const el = document.getElementById(elId);
      const evt = el.tagName === 'TEXTAREA' ? 'input' : 'change';
      el.addEventListener(evt, () => {
        if (selectedIdx < 0) return;
        cellData[selectedIdx][field] = transform ? transform(el.value) : el.value;
        renderCell(selectedIdx);
      });
    }

    // ===== HTMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ =====
    function exportHTML() {
      const bgExportPath = document.getElementById('bgExportPath').value.trim();
      let bgCSS = '';
      if (bgExportPath) {
        bgCSS = `
    .bg-layer {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url(${bgExportPath});
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      z-index: 0;
    }`;
      }

      let cellsHTML = '';
      for (let r = 0; r < ROWS; r++) {
        cellsHTML += `    <div class="grid-row" style="--w:2; --h:1;">\n`;
        for (let c = 0; c < COLS; c++) {
          const d = cellData[r * COLS + c];
          const wm = d.writingMode === 'v' ? 'writing-mode:vertical-rl;' : '';
          let ha, va;
          if (d.writingMode === 'v') {
            // ç¸¦æ›¸ã: justify-content=ç¸¦æƒãˆ, align-items=æ¨ªæƒãˆï¼ˆå·¦å³åè»¢ï¼‰
            ha = d.hAlign === 'center' ? 'align-items:center;'
               : d.hAlign === 'right'  ? 'align-items:flex-start;'
               : 'align-items:flex-end;';
            va = d.vAlign === 'top' ? 'justify-content:flex-start;'
               : d.vAlign === 'bottom' ? 'justify-content:flex-end;'
               : 'justify-content:center;';
          } else {
            ha = d.hAlign === 'center' ? 'text-align:center;justify-content:center;'
               : d.hAlign === 'right'  ? 'text-align:right;justify-content:flex-end;'
               : 'text-align:left;justify-content:flex-start;';
            va = d.vAlign === 'top' ? 'align-items:flex-start;'
               : d.vAlign === 'bottom' ? 'align-items:flex-end;'
               : 'align-items:center;';
          }
          const style = `font-family:${d.fontFamily};font-size:${d.fontSize}px;font-weight:${d.fontWeight};color:${d.fontColor};${wm}${ha}${va}`;
          let text;
          if (d.inputMode === 'md' && d.text.trim()) {
            text = `<div class="md-inner">${parseMD(d.text)}</div>`;
          } else {
            text = d.text ? escapeHTML(d.text) : `<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ${r+1}-${c+1} -->`;
          }
          const mdClass = d.inputMode === 'md' && d.text.trim() ? ' md-rendered' : '';
          cellsHTML += `      <div class="grid-item" style="grid-column: span 4;">\n`;
          cellsHTML += `        <div class="grid-item-inner${mdClass}" style="${style}">\n`;
          cellsHTML += `          ${text}\n`;
          cellsHTML += `        </div>\n`;
          cellsHTML += `      </div>\n`;
        }
        cellsHTML += `    </div>\n`;
      }

      const html = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family: 'Noto Sans JP', sans-serif;
      background:#f5f5f5;
    }${bgCSS}
    .container{
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .grid-row{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 15px;
      margin-bottom: 15px;
      aspect-ratio: var(--w) / var(--h);
    }
    .grid-item{
      background: transparent;
      border-radius: 10px;
      overflow:hidden;
    }
    .grid-item:nth-child(3n+2){
      background: rgba(255,255,255,0.5);
    }
    .grid-item > img{
      width:100%; height:100%; object-fit: cover; display:block;
    }
    .grid-item-inner{
      width:100%; height:100%;
      display:flex;
      padding: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .md-rendered { white-space: normal; }
    .md-rendered .md-inner { width: 100%; }
    .md-rendered h1 { font-size:1.6em; font-weight:700; margin:0.3em 0; }
    .md-rendered h2 { font-size:1.35em; font-weight:700; margin:0.3em 0; }
    .md-rendered h3 { font-size:1.15em; font-weight:700; margin:0.25em 0; }
    .md-rendered h4 { font-size:1em; font-weight:700; margin:0.2em 0; }
    .md-rendered p { margin:0.3em 0; }
    .md-rendered strong { font-weight:700; }
    .md-rendered em { font-style:italic; }
    .md-rendered code { background:rgba(128,128,128,0.2); padding:1px 5px; border-radius:3px; font-family:monospace; font-size:0.9em; }
    .md-rendered pre { background:rgba(0,0,0,0.1); padding:8px 10px; border-radius:6px; overflow-x:auto; margin:0.4em 0; white-space:pre-wrap; }
    .md-rendered pre code { background:none; padding:0; }
    .md-rendered ul, .md-rendered ol { padding-left:1.5em; margin:0.3em 0; }
    .md-rendered li { margin:0.15em 0; }
    .md-rendered blockquote { border-left:3px solid #e94560; padding-left:10px; margin:0.4em 0; opacity:0.85; }
    .md-rendered hr { border:none; border-top:1px solid rgba(128,128,128,0.4); margin:0.5em 0; }
    .md-rendered a { color:#5ba8ff; text-decoration:underline; }
    .md-rendered img { max-width:100%; border-radius:4px; }
    @media (max-width: 768px){
      .grid-row{ grid-template-columns: 1fr !important; aspect-ratio:auto; }
      .grid-item{ aspect-ratio: var(--w) / var(--h); }
    }
  </style>
</head>
<body>
  ${bgExportPath ? '<div class="bg-layer"></div>' : ''}
  <div class="container">
${cellsHTML}  </div>
</body>
</html>`;

      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '3retu36Ptemp.html';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function escapeHTML(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }

    // ===== åˆæœŸåŒ– =====
    function init() {
      buildGrid();
      renderAll();

      initToggleGroup('writingMode', 'writingMode');
      initToggleGroup('hAlign', 'hAlign');
      initToggleGroup('vAlign', 'vAlign');

      // inputMode ã¯ç‰¹æ®Šãƒãƒ³ãƒ‰ãƒ©ä»˜ã
      const imBtns = document.querySelectorAll('#inputMode .toggle-btn');
      imBtns.forEach(b => {
        b.onclick = () => {
          imBtns.forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          if (selectedIdx >= 0) {
            cellData[selectedIdx].inputMode = b.dataset.val;
            renderCell(selectedIdx);
            // MDãƒ˜ãƒ«ãƒ—åˆ‡æ›¿
            document.getElementById('mdHelp').style.display = b.dataset.val === 'md' ? '' : 'none';
            document.getElementById('cellText').placeholder = b.dataset.val === 'md'
              ? '# è¦‹å‡ºã—\n**å¤ªå­—** *æ–œä½“*\n- ãƒªã‚¹ãƒˆé …ç›®'
              : 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦';
          }
        };
      });

      bindInput('cellText', 'text');
      bindInput('fontFamily', 'fontFamily');
      bindInput('fontSize', 'fontSize', v => parseInt(v) || 16);
      bindInput('fontWeight', 'fontWeight');
      bindInput('fontColor', 'fontColor');

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç©ºç™½ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠè§£é™¤
      document.getElementById('previewArea').addEventListener('click', (e) => {
        if (!e.target.closest('.grid-cell')) deselectCell();
      });
    }

    init();
  </script>
</body>
</html>
